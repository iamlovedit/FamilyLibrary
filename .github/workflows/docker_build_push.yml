# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  push:
    branches: [ "preproduction" ]

jobs:
  docker:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: et up Docker Buildx
        uses: docker/setup-buildx-action@v2
        
      - name: Login to ACR
        uses: aliyun/acr-login@v1
        with:
          login-server: "${{ secrets.aliyun_docker_register_server }}"
          username: "${{ secrets.aliyun_docker_register_username }}"
          password: "${{ secrets.aliyun_docker_register_password }}"
          
      - name: Build and push image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t "${{ secrets.aliyun_docker_register }}"/galaservices/library_gateway -f ./Source/GalaFamilyLibrary.Gateway/Dockerfile .
          docker push "${{ secrets.aliyun_docker_register }}"/galaservices/library_gateway
          
          docker build -t "${{ secrets.aliyun_docker_register }}"/galaservices/dynamo_package -f ./Source/GalaFamilyLibrary.DynamoPackageService/Dockerfile .
          docker push "${{ secrets.aliyun_docker_register }}"/galaservices/dynamo_package
          
          docker build -t "${{ secrets.aliyun_docker_register }}"/galaservices/family_library -f ./Source/GalaFamilyLibrary.FamilyService/Dockerfile .
          docker push "${{ secrets.aliyun_docker_register }}"/galaservices/family_library
          
          docker build -t "${{ secrets.aliyun_docker_register }}"/galaservices/library_user -f ./Source/GalaFamilyLibrary.UserService/Dockerfile .
          docker push "${{ secrets.aliyun_docker_register }}"/galaservices/library_user
      
